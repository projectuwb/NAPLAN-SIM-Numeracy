name: Auto-merge Claude branches

on:
  push:
    branches:
      - 'claude/**'

jobs:
  auto-merge-to-main:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and merge PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          echo "üìã Checking for existing PR from $BRANCH_NAME to main..."

          # Check if PR already exists
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            echo "‚ú® No existing PR found. Creating new PR..."

            # Create PR
            PR_NUMBER=$(gh pr create \
              --title "Auto-merge: $BRANCH_NAME" \
              --body "ü§ñ **Automatic PR from Claude Code**

            This PR was automatically created from branch \`$BRANCH_NAME\`.

            Changes will be automatically merged to main." \
              --base main \
              --head "$BRANCH_NAME" \
              --json number \
              --jq '.number')

            echo "‚úÖ Created PR #$PR_NUMBER"
          else
            echo "‚ÑπÔ∏è  Found existing PR #$PR_NUMBER"
          fi

          # Check if PR is open (not already merged/closed)
          PR_STATE=$(gh pr view "$PR_NUMBER" --json state --jq '.state')

          if [ "$PR_STATE" = "OPEN" ]; then
            echo "üîÑ Merging PR #$PR_NUMBER..."

            # Merge the PR
            gh pr merge "$PR_NUMBER" \
              --squash \
              --delete-branch \
              --auto

            echo "‚úÖ PR merged successfully!"
          else
            echo "‚ÑπÔ∏è  PR #$PR_NUMBER is already $PR_STATE. Nothing to do."
          fi
